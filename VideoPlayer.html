<head>
    <link href="http://vjs.zencdn.net/5.17.0/video-js.css" rel="stylesheet">
    <script src="http://vjs.zencdn.net/5.17.0/video.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script type="text/javascript" src="fonctions.js"></script>
    <script type="text/javascript" src="fonction_stopWord.js"></script>
    <script type='text/javascript' src='https://api.stackexchange.com/js/2.0/all.js'></script>
    <link href="//players.brightcove.net/videojs-overlay/1/videojs-overlay.css" rel='stylesheet'>
    <script src="//players.brightcove.net/videojs-overlay/1/videojs-overlay.min.js"></script>

</head>

<body>
    <h1>Video Player </h1>
    <!-- VIDEO PLAYER -->
    <video id="my-video" class="video-js" controls preload="auto" width="640" height="264" data-setup="{}">
    <source src="uploads/3 - 1 - Lecture 2.1 - Tail Recursion (1232) - jwformat.mp4" type='video/mp4'></video>

    <!-- Configuration -->
    <br />
    <form name="config">
    <select name="choice" onchange="diri()">
    <option>Configuration : Par defaut</option>
    <option>Configuration : Help</option>
    <option>Configuration : Pause</option>
    <option>Configuration : Temps</option>
    </select>
    </form>
    
    <!-- HELP LINKS -->
    <p> Help section : </p>
    <!-- BUTTON -->
    <button onclick="makeQuery()"> Query to StackOverflow</button>

    <div id = "help">
    <button onclick="help()"> HELP</button>
    </div>
    <br /><br />
    <a id="q0" href="http://stackoverflow.com/"> stackoverflow </a><br /><br />
    <a id="q1" href="http://stackoverflow.com/"> </a><br /><br />
    <a id="q2" href="http://stackoverflow.com/"> </a><br /><br />
    <a id="q3" href="http://stackoverflow.com/"> </a><br /><br />
    <a id="q4" href="http://stackoverflow.com/"> </a><br /><br />

    <script>
        var player = videojs('my-video');
        var time = 0; //use to register the time when user paused the video
        var vtt = new Array(); //Array with all the subtitels
        var Time = new Array(); //time array with min max and index 
        var wantedVTT = new Array();
        var baseURL = 'http://stackoverflow.com/questions/'; //Use to acces stackoverflow with question id 
        var index = 0;          //Use to acess the array of timeHelp
        var configPause = 1;  

        var arg = 'test'
        player.overlay(arg, function(){
            overlays: [{
              align: "top",
              content: "test",
              start: 'play',
              end: 'pause'
            }, {
              content: 'This timed overlay message appears between 5 and 10 seconds',
              start: 5,
              end: 10,
              align: 'bottom-right'
            }, {
              start: 12,
              end: 17,
              align: 'bottom-left'
            }]
        });


        var interval = setInterval(checkTime, 100);     //Use to call checkTime every 100ms
        

        var time = function(min, max, index) {
            this.min = min;
            this.max = max;
            this.index = index;
        }

        function diri(){
            var choix = document.config.choice.selectedIndex;
            switch (choix){
            case 1:
                //Configuration Help
                document.getElementById("help").style.display = "initial";
                configPause = 0; 
                clearInterval(interval); 
                break;
            case 2:
                //Configuration Pause
                document.getElementById("help").style.display = "none";
                configPause = 1; 
                clearInterval(interval); 
                break;
            case 3: 
                //Configuration Temps
                document.getElementById("help").style.display = "none";
                configPause = 0; 
                interval = setInterval(checkTime, 100);
                break;
            default:
                configPause = 1; 
                interval = setInterval(checkTime, 100);
                document.getElementById("help").style.display = "initial";
                break;
            }
            console.log(choix, "config Pause = ", configPause, "config time = ", configTime); 
        }

        //Exemple of time where student have some difficulty
        var timeHelp = new Array(4.0, 15.0, 30.00);

        //Initialized subtitles and times array
        vtt = ReadAsArray('uploads/subtitles.vtt');
        Time = ExtractTime(vtt);

        function makeQuery() {
            //paused the video and query stackoverflow 
            player.pause();
            for(i = 0; i < 5; i++){
                ChangeURL('q' + i, "", "");
            }
            queryStackOverflow();

        }
        
        /**
        * Check if curruent time is equal to the element of timeHelp at index if equal pause and display stackoverflow result
        *
        */
		function checkTime(){
            console.log("test"); 
			if(Math.floor(player.currentTime()) == timeHelp[index]){
				index++; 
				player.pause();
                mainCaller(); 
  				console.log("Time reached!");
			}
		}
        /**
        * If user click on help button pause video and display stackoverflow result
        */
        function help(){
            player.pause(); 
        }
        /**
        * Update time wantedVTT and keyword to make a query on stackoverflow
        */
        function mainCaller(){
        	time = player.currentTime();
            wantedVTT = CurrentContent(time, vtt, Time);
            var key_word = Find_Key_Word(wantedVTT);
            ask_stackoverflow('q', 'scala+tail-recursion' + key_word);
            player.exitFullscreen(); 
        }

        player.on('pause', function() {
            console.log("pause " + time);
            if (configTime){
                mainCaller(); 
            }
        });

        player.on('play', function() {
            for(i = 0; i < 5; i++){
                ChangeURL('q' + i, "", "");
            }
            console.log("play " + player.currentTime());
        });
        player.on('seeked', function() {
            time = player.currentTime();
            console.log("seeked " + time);
        });


        function ask_stackoverflow(type = 'q', query = '', tag = '', body = '') {
            var url = 'https://api.stackexchange.com/2.2/search/';
            switch (type) {
                //Switch to chose the mode of query stactoverflow
                case 'q':
                    url += 'excerpts?order=desc&sort=relevance&q=' + query + '&site=stackoverflow';
                    break;
                case 'o':
                    break;
                default:
            }
            var res = fetch(url)
                .then(function(response) {
                    if (response.ok) {
                        return response.json();
                    }
                })
                .then(function(rJsn) {
                    for (i = 0; i < rJsn.items.length; i++) {
                        var item = rJsn.items[i];
                        var id = item.question_id;
                        var title = item.title;
                        if (i < 5) {
                            ChangeURL('q' + i, baseURL + id, title);
                        }
                    }
                });
        }
    </script>
</body>