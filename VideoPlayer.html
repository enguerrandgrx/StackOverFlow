<head>
    <link href="http://vjs.zencdn.net/5.17.0/video-js.css" rel="stylesheet">
    <script src="http://vjs.zencdn.net/5.17.0/video.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script type="text/javascript" src="fonctions.js"></script>
    <script type="text/javascript" src="fonction_stopWord.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
    <script type='text/javascript' src='https://api.stackexchange.com/js/2.0/all.js'></script>
    <script src="//players.brightcove.net/videojs-overlay/1/videojs-overlay.min.js"></script>

</head>

<body>
    
    <!-- Configuration -->
    <br />
    <form name="config">
    <select name="choice" onchange="diri()">
    <option>Configuration : Par defaut</option> 
    <option>Configuration : Help</option>
    <option>Configuration : Pause</option>
    <option>Configuration : Time</option>
    </select>
    </form>

    <!-- VIDEO PLAYER -->
    <video id="my-video" class="video-js" controls preload="auto" width="640" height="264" data-setup="{}">
    <source src="uploads/3 - 1 - Lecture 2.1 - Tail Recursion (1232) - jwformat.mp4" type='video/mp4'></video>

    <script>
        var player = videojs('my-video');
        var time = 0; //use to register the time when user paused the video
        var currentTime = 0; 
        var vtt = new Array(); //Array with all the subtitels
        var Time = new Array(); //time array with min max and index 
        var wantedVTT = new Array();
        var baseURL = 'http://stackoverflow.com/questions/'; //Use to acces stackoverflow with question id 
        var index = 0;          //Use to acess the array of timeHelp
        var configPause = 0; 
        var configHelp = 0; 
        var timeDisplay = -11;
        var timeDisplayHelp = -11; 


        var titleHelp = 'Help'
        var overlayHelp = '<button onclick="help()">'+titleHelp+'</button>'; 


        /**
        * If user click on help button pause video and display stackoverflow result
        */
        function help(){
            player.pause();
            mainCaller(); 
            console.log("temps : ", player.currentTime())
        }

 
        var overlay = [
        {
            title: titleHelp, 
            content: overlayHelp,
            start: timeDisplayHelp,
            end:  timeDisplayHelp,
            align: 'bottom-left',
        },
        {   
            content: '', 
            title: '', 
            start: 0,
            end:  timeDisplay,
            align: 'left',
        }, 
        {   
            title: '', 
            content: '', 
            start: 0,
            end: timeDisplay,
            align: 'left2',
        }, 
        {   
            title: '',  
            content: '', 
            start: timeDisplay,
            end: timeDisplay,
            align: 'left3',
        }, 
        {
            title: '', 
            content: '', 
            start: timeDisplay,
            end: timeDisplay,
            align: 'left4',
        }, 
        {
            title: '', 
            content: '', 
            start: timeDisplay,
            end: timeDisplay,
            align: 'left5',
        }]; 

    

        var time = function(min, max, index) {
            this.min = min;
            this.max = max;
            this.index = index;
        }

        function updateCurrentTime(){
        	currentTime = player.currentTime(); 
        }

        
        //Exemple of time where student have some difficulty
        var timeHelp = new Array(4.0, 15.0, 30.00);

        //Initialized subtitles and times array
        vtt = ReadAsArray('uploads/subtitles.vtt');
        Time = ExtractTime(vtt);

        
        /**
        * Check if curruent time is equal to the element of timeHelp at index if equal pause and display stackoverflow result
        *
        */
		function checkTime(){
            //console.log("test"); 
			if(Math.floor(player.currentTime()) == timeHelp[index]){
				index++; 
				player.pause();
                mainCaller(); 
  				console.log("Time reached!");
			}
		}
        
        /**
        * Update time wantedVTT and keyword to make a query on stackoverflow
        */
        function mainCaller(){
        	time = player.currentTime();
            wantedVTT = CurrentContent(time, vtt, Time);
            var key_word = Find_Key_Word(wantedVTT);
            ask_stackoverflow('q', 'scala+tail-recursion' + key_word);
        }

        player.on('pause', function() {
            time = player.currentTime();
            console.log("pause : " + time);
            if (configPause){
                mainCaller();
            } 
            seekedback = 1; 
        });

      
        player.on('play', function() {
            console.log("play " + player.currentTime());
        });


        player.on('seeked', function() {
            time = player.currentTime();
 			if (currentTime  < time ||  Math.abs(currentTime - time) < 2){
                seekedback = 0; 
 				console.log("seekback NO", currentTime - time); 
            } else {
 				seekedback = 1; 
                mainCaller(); 
 				console.log("seekback YES"); 
 			}
            console.log("seeked " + time);
        });

        function ChangeOverlay(index, url, title){
            overlay[index]["title"] = title; 
            overlay[index]["start"] = 0; 
            overlay[index]["end"] = timeDisplay + 3; 
            overlay[index]["content"] = '<a href='+url+'>'+title+'</a>'; 
        }

        function ask_stackoverflow(type = 'q', query = '', tag = '', body = '') {
            var url = 'https://api.stackexchange.com/2.2/search/'; 
            timeDisplay = player.currentTime(); 
            switch (type) {
                //Switch to chose the mode of query stactoverflow
                case 'q':
                    url += 'excerpts?order=desc&sort=relevance&q=' + query + '&site=stackoverflow';
                    break;
                case 'o':
                    break;
                default:
            }
            var res = fetch(url)
                .then(function(response) {
                    if (response.ok) {
                        return response.json();
                    }
                })
            .then(function(rJsn) {
                for (i = 0; i < rJsn.items.length; i++) {
                    var item = rJsn.items[i];
                    var id = item.question_id;
                    var title = item.title;
                    if (i < 5) {
                        ChangeOverlay(i+1, baseURL + id, title);                             
                    }
                }
                player.currentTime(timeDisplay-0.001);
                player.overlay({
                   overlays: overlay,
                });
                player.currentTime(timeDisplay);
            });
        }
    </script>
</body>